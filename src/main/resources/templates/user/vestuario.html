<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Vestuario</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <script>
        function toggleVestuario(vestuarioId, checkbox) {
            const obtenido = checkbox.checked;

            fetch("/user/progreso/vestuario/toggle", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "vestuarioId=" + vestuarioId + "&obtenido=" + obtenido
            })
            .then(response => {
                if (!response.ok) {
                    console.error("Error al actualizar el estado del vestuario");
                }
            })
            .catch(err => console.error("Error:", err));
        }
    </script>
</head>

<body class="bg-light">
<div th:replace="fragments/navbar :: navbarUsuario"></div>

<div class="container mt-4">

    <div class="text-center mb-4">
        <h2 class="fw-bold">Mi Vestuario üëó</h2>
        <p class="text-muted">Activa el switch cuando hayas conseguido un atuendo.</p>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="list-group list-group-flush">

                <div th:each="v : ${vestuarios}" class="list-group-item d-flex justify-content-between align-items-center">
                    
                    <!-- INFO DEL VESTUARIO -->
                    <div class="d-flex align-items-center">
                        <img th:if="${v.imagen != null}" th:src="@{${v.imagen}}"
                             class="rounded me-3" style="width:100px; height:100%; object-fit:cover;">
                        <div>
                            <strong th:text="${v.nombre}"></strong><br>
                            <small class="descripcion-vestuario" th:text="${v.descripcion}"></small>
                        </div>
                    </div>


<div class="alineado-horizontal">

                    <!-- SWITCH -->
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               th:checked="${idsObtenidos != null and idsObtenidos.contains(v.id)}"
                               th:onchange="'toggleVestuario(' + ${v.id} + ', this)'">
                    </div>


                    <!-- RESE√ëA -->
                    <div class="d-flex flex-column align-items-end">
                        <form action="/resenas/agregar" method="post" class="mt-3 w-100">

                            <input type="hidden" name="objetoId" th:value="${v.id}">
                            <input type="hidden" name="tipoObjeto" value="vestuario">

                            <!-- ‚≠ê CALIFICACI√ìN EST√âTICA DE CORAZONES ‚≠ê -->
                            <div class="rating mb-2">

                                <input type="radio" id="c5_${v.id}" name="calificacion_${v.id}" value="5" checked>
                                <label for="c5_${v.id}">‚ù§Ô∏è</label>

                                <input type="radio" id="c4_${v.id}" name="calificacion_${v.id}" value="4">
                                <label for="c4_${v.id}">‚ù§Ô∏è</label>

                                <input type="radio" id="c3_${v.id}" name="calificacion_${v.id}" value="3">
                                <label for="c3_${v.id}">‚ù§Ô∏è</label>

                                <input type="radio" id="c2_${v.id}" name="calificacion_${v.id}" value="2">
                                <label for="c2_${v.id}">‚ù§Ô∏è</label>

                                <input type="radio" id="c1_${v.id}" name="calificacion_${v.id}" value="1">
                                <label for="c1_${v.id}">‚ù§Ô∏è</label>

                                <!-- üî• Hidden que realmente se env√≠a (igual al de gatos) -->
                                <input type="hidden" name="calificacion" value="5">
                            </div>

                            <textarea name="comentario" class="form-control"></textarea>

                            <div class="d-flex justify-content-end mt-2">
                                <button class="btn-rosa">Enviar rese√±a</button>
                                <a th:href="@{'/resenas/ver/vestuario/' + ${v.id}}" class="btn-rosaclaro">Ver rese√±as</a>
                            </div>

                        </form>
                    </div>
</div>


                </div>

            </div>
        </div>
    </div>

</div>

<!-- ‚≠ê SCRIPT QUE ACTUALIZA EL VALOR REAL DE calificacion (id√©ntico al de gatos) ‚≠ê -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.rating').forEach(ratingBlock => {
        const radios = Array.from(ratingBlock.querySelectorAll('input[type="radio"]'));
        const hidden = ratingBlock.querySelector('input[type="hidden"][name="calificacion"]');

        if (!hidden || radios.length === 0) return;

        const checked = radios.find(r => r.checked);
        hidden.value = checked ? checked.value : radios[0].value;

        radios.forEach(r =>
            r.addEventListener('change', (ev) => {
                if (ev.target.checked) {
                    hidden.value = ev.target.value;
                }
            })
        );
    });
});
</script>

</body>
</html>


