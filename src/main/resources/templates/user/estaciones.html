<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mis Estaciones üè°üê±</title>

    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">


    <script>
        function toggleEstacion(estacionId, checkbox) {
            const obtenido = checkbox.checked;
            fetch("/user/progreso/estaciones/toggle", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "estacionId=" + estacionId + "&obtenido=" + obtenido
            });
        }
    </script>
</head>

<body class="bg-light">
<div th:replace="fragments/navbar :: navbarUsuario"></div>

<div class="container mt-4">

    <div class="text-center mb-4">
        <h2 class="fw-bold">Mis Estaciones üè°üê±</h2>
        <p class="text-muted">Activa el switch cuando hayas desbloqueado una estaci√≥n.</p>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="list-group list-group-flush">

                <!-- ‚úÖ LISTADO DE ESTACIONES -->
                <div th:each="e : ${estaciones}" class="list-group-item d-flex justify-content-between align-items-center">

                    <!-- ‚úÖ INFO DE LA ESTACI√ìN -->
                    <div class="d-flex align-items-center">
                        <img th:if="${e.imagen != null}" th:src="@{${e.imagen}}"
                             class="rounded me-3" style="width:100px; height:100%; object-fit:cover;">
                        <div>
                            <strong th:text="${e.nombre}"></strong><br>
                            <small class="descripcion" th:text="${e.descripcion}"></small>
                        </div>
                    </div>

                    <!-- ‚úÖ SWITCH -->
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               th:checked="${idsObtenidas != null and idsObtenidas.contains(e.id)}"
                               th:onchange="'toggleEstacion(' + ${e.id} + ', this)'">
                    </div>
<!-- ‚úÖ RESE√ëA -->
<!-- ‚úÖ RESE√ëA corregida -->
<div class="d-flex flex-column align-items-end">
    <form action="/resenas/agregar" method="post" class="mt-3 w-100">

        <input type="hidden" name="objetoId" th:value="${e.id}">
        <input type="hidden" name="tipoObjeto" value="estacion">

        <!-- ‚≠ê CALIFICACI√ìN EST√âTICA DE CORAZONES (id√©ntico a gatos) ‚≠ê -->
        <div class="rating mb-2" style="direction: rtl; unicode-bidi: bidi-override;">

            <input type="radio" id="c5_e${e.id}" name="calificacion_${e.id}" value="5" checked>
            <label for="c5_e${e.id}">‚ù§Ô∏è</label>

            <input type="radio" id="c4_e${e.id}" name="calificacion_${e.id}" value="4">
            <label for="c4_e${e.id}">‚ù§Ô∏è</label>

            <input type="radio" id="c3_e${e.id}" name="calificacion_${e.id}" value="3">
            <label for="c3_e${e.id}">‚ù§Ô∏è</label>

            <input type="radio" id="c2_e${e.id}" name="calificacion_${e.id}" value="2">
            <label for="c2_e${e.id}">‚ù§Ô∏è</label>

            <input type="radio" id="c1_e${e.id}" name="calificacion_${e.id}" value="1">
            <label for="c1_e${e.id}">‚ù§Ô∏è</label>

            <!-- ‚úÖ Hidden que el backend realmente usa -->
            <input type="hidden" name="calificacion" value="5">
        </div>

        <textarea name="comentario" class="form-control"></textarea>

        <div class="d-flex justify-content-end mt-2">
            <button class="btn-rosa">Enviar rese√±a</button>
            <a th:href="@{'/resenas/ver/estacion/' + ${e.id}}" class="btn-rosaclaro">Ver rese√±as</a>
        </div>

    </form>
</div>


                </div>

            </div>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.rating').forEach(ratingBlock => {
        const radios = Array.from(ratingBlock.querySelectorAll('input[type="radio"]'));
        const hidden = ratingBlock.querySelector('input[type="hidden"][name="calificacion"]');

        if (!hidden || radios.length === 0) return;

        // Valor inicial
        const checked = radios.find(r => r.checked);
        hidden.value = checked ? checked.value : radios[0].value;

        // Actualizar hidden al cambiar
        radios.forEach(r =>
            r.addEventListener('change', (ev) => {
                if (ev.target.checked) {
                    hidden.value = ev.target.value;
                }
            })
        );
    });
});
</script>


</body>
</html>

