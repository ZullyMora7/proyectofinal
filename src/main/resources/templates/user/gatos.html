<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gatos</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <script>
        function toggleGato(gatoId, checkbox) {
            const obtenido = checkbox.checked;

            fetch("/user/progreso/gatos/toggle", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "gatoId=" + gatoId + "&obtenido=" + obtenido
            })
            .then(response => {
                if (!response.ok) {
                    console.error("Error al actualizar el estado del gato");
                }
            })
            .catch(err => console.error("Error:", err));
        }
    </script>
</head>

<body class="bg-light">
<div th:replace="fragments/navbar :: navbarUsuario"></div>

<div class="container mt-4">

    <div class="text-center mb-4">
        <h2 class="fw-bold">Mis Gatos üê±</h2>
        <p class="text-muted">Activa el switch cuando hayas conseguido un gato.</p>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="list-group list-group-flush">

                <div th:each="g : ${gatos}" class="list-group-item d-flex justify-content-between align-items-center">
                    
                    <!-- INFO DEL GATO -->
                    <div class="d-flex align-items-center">
                        <img th:if="${g.imagen != null}" th:src="@{${g.imagen}}"
                             class="rounded me-3" style="width:100px; height:100%; object-fit:cover;">
                        <div>
                            <strong th:text="${g.nombre}"></strong><br>
                            <small class="descripcion-gato" th:text="${g.descripcion}"></small>
                        </div>
                    </div>


<div class="alineado-horizontal">
                    <!-- SWITCH -->
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               th:checked="${idsObtenidos != null and idsObtenidos.contains(g.id)}"
                               th:onchange="'toggleGato(' + ${g.id} + ', this)'">
                    </div>


                    <!-- RESE√ëA -->
                    <div class="d-flex flex-column align-items-end">
                        <form action="/resenas/agregar" method="post" class="mt-3 w-100">

                            <input type="hidden" name="objetoId" th:value="${g.id}">
                            <input type="hidden" name="tipoObjeto" value="gato">

                            <!-- ‚≠ê CALIFICACI√ìN EST√âTICA DE CORAZONES ‚≠ê -->
<div class="rating mb-2" th:attr="data-gato-id=${g.id}">

    <input type="radio" id="c5_${g.id}" th:name="'calif_temp_' + ${g.id}" value="5"checked>
    <label for="c5_${g.id}">‚ù§Ô∏è</label>

    <input type="radio" id="c4_${g.id}" th:name="'calif_temp_' + ${g.id}" value="4">
    <label for="c4_${g.id}">‚ù§Ô∏è</label>

    <input type="radio" id="c3_${g.id}" th:name="'calif_temp_' + ${g.id}" value="3">
    <label for="c3_${g.id}">‚ù§Ô∏è</label>

    <input type="radio" id="c2_${g.id}" th:name="'calif_temp_' + ${g.id}" value="2">
    <label for="c2_${g.id}">‚ù§Ô∏è</label>

    <input type="radio" id="c1_${g.id}" th:name="'calif_temp_' + ${g.id}" value="1" >
    <label for="c1_${g.id}">‚ù§Ô∏è</label>

    <input type="hidden"
           name="calificacion"
           th:id="'hiddenReal_' + ${g.id}"
           value="5">
</div>

                            <textarea name="comentario" class="form-control"></textarea>

                            <div class="d-flex justify-content-end mt-2">
                                <button class="btn-rosa">Enviar rese√±a</button>
                                <a th:href="@{'/resenas/ver/gato/' + ${g.id}}" class="btn-rosaclaro">Ver rese√±as</a>
                            </div>

                        </form>
                    </div>
</div>


                </div>

            </div>
        </div>
    </div>

</div>

<!-- üî• SCRIPT CORREGIDO DEFINITIVAMENTE -->
<script>
document.querySelectorAll(".rating").forEach(rating => {

    const radios = rating.querySelectorAll("input[type='radio']");
    const hidden = rating.querySelector("input[type='hidden']");

    radios.forEach(r => {
        r.addEventListener("change", () => {
            hidden.value = r.value;
        });
    });

});
</script>

</body>
</html>

